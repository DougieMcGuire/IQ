<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Profile | IQ Profile</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=Patrick+Hand&family=Nunito:wght@400;600;700;800&display=swap" rel="stylesheet">
  <style>
    :root {
      --bg: #F2EBD9;
      --card: #EDE5CF;
      --tan: #C4AD8A;
      --tan-dark: #A89872;
      --ink: #2A2018;
      --ink-light: #6B5740;
      --green: #5EB85E;
    }
    * { box-sizing: border-box; margin: 0; padding: 0; }
    html, body { 
      width: 100%; height: 100%; 
      font-family: 'Nunito', sans-serif;
      background: var(--bg);
      color: var(--ink);
    }
    body { display: flex; flex-direction: column; }

    /* Navigation */
    nav {
      position: fixed; bottom: 0; left: 0; right: 0;
      height: 70px;
      background: var(--card);
      border-top: 2px solid var(--tan);
      display: flex; justify-content: center; align-items: center; gap: 8px;
      z-index: 100;
      padding-bottom: env(safe-area-inset-bottom);
    }
    .nav-btn {
      padding: 10px 36px;
      background: none; border: none;
      display: flex; flex-direction: column; align-items: center; gap: 4px;
      color: var(--ink-light);
      font-family: 'Patrick Hand', cursive;
      font-size: 13px;
      text-decoration: none;
      border-radius: 14px;
      transition: all 0.2s;
    }
    .nav-btn svg { width: 24px; height: 24px; stroke: currentColor; fill: none; stroke-width: 2; }
    .nav-btn.active { color: var(--ink); background: rgba(196,173,138,0.3); }
    .nav-divider { width: 2px; height: 30px; background: var(--tan); }

    main {
      flex: 1;
      overflow-y: auto;
      padding: 20px 16px 85px;
    }

    /* Header */
    .header {
      display: flex;
      justify-content: flex-end;
      margin-bottom: 20px;
    }
    .share-btn {
      background: var(--card);
      border: 2px solid var(--tan);
      border-radius: 20px;
      padding: 8px 16px;
      font-family: 'Patrick Hand', cursive;
      font-size: 14px;
      color: var(--ink);
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 6px;
    }
    .share-btn svg { width: 16px; height: 16px; stroke: currentColor; fill: none; stroke-width: 2; }

    /* Profile Card */
    .profile-card {
      background: var(--card);
      border: 2.5px solid var(--tan);
      border-radius: 24px;
      padding: 28px 20px;
      display: flex;
      align-items: center;
      gap: 20px;
      margin-bottom: 20px;
      position: relative;
    }
    .profile-card::before {
      content: '';
      position: absolute;
      top: -8px; left: 24px;
      width: 40px; height: 16px;
      background: var(--bg);
      border: 2.5px solid var(--tan);
      border-bottom: none;
      border-radius: 8px 8px 0 0;
    }

    .avatar-side {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 8px;
    }
    .avatar {
      width: 80px; height: 80px;
      border-radius: 50%;
      background: var(--bg);
      border: 3px solid var(--tan);
      overflow: hidden;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
    }
    .avatar img { width: 100%; height: 100%; object-fit: cover; display: none; }
    .avatar svg { width: 36px; height: 36px; stroke: var(--tan-dark); fill: none; stroke-width: 1.5; }
    #avatar-input { display: none; }

    .iq-display {
      text-align: center;
    }
    .iq-num {
      font-family: 'Verdana', sans-serif;
      font-size: 56px;
      font-weight: 700;
      line-height: 1;
    }
    .iq-label {
      font-family: 'Patrick Hand', cursive;
      font-size: 14px;
      color: var(--ink-light);
      letter-spacing: 2px;
    }
    .pct-badge {
      background: var(--tan-dark);
      color: var(--bg);
      font-family: 'Patrick Hand', cursive;
      font-size: 12px;
      padding: 3px 10px;
      border-radius: 10px;
      margin-top: 6px;
      display: inline-block;
    }

    .stats-side {
      flex: 1;
      display: flex;
      flex-direction: column;
      gap: 8px;
    }
    .stat-row {
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .stat-row .icon { font-size: 16px; width: 24px; text-align: center; }
    .stat-row .val {
      font-family: 'Verdana', sans-serif;
      font-size: 18px;
      font-weight: 700;
      min-width: 45px;
    }
    .stat-row .lbl {
      font-family: 'Patrick Hand', cursive;
      font-size: 13px;
      color: var(--ink-light);
    }

    /* Level Bar */
    .level-section {
      background: var(--card);
      border: 2px solid var(--tan);
      border-radius: 16px;
      padding: 14px 16px;
      margin-bottom: 20px;
    }
    .level-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 8px;
    }
    .level-header .lvl {
      font-family: 'Patrick Hand', cursive;
      font-size: 16px;
      display: flex;
      align-items: center;
      gap: 6px;
    }
    .level-header .xp {
      font-family: 'Patrick Hand', cursive;
      font-size: 13px;
      color: var(--ink-light);
    }
    .level-bar-outer {
      height: 12px;
      background: var(--tan-dark);
      border-radius: 6px;
      overflow: hidden;
    }
    .level-bar-inner {
      height: 100%;
      background: var(--green);
      border-radius: 6px;
      transition: width 0.4s ease;
    }

    /* Abilities */
    .section-title {
      font-family: 'Patrick Hand', cursive;
      font-size: 14px;
      color: var(--ink-light);
      letter-spacing: 1px;
      margin-bottom: 12px;
      padding-left: 4px;
    }

    .abilities-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
    }
    .ability-card {
      background: var(--card);
      border: 2px solid var(--tan);
      border-radius: 14px;
      padding: 12px 14px;
    }
    .ability-name {
      font-family: 'Patrick Hand', cursive;
      font-size: 12px;
      color: var(--ink-light);
      margin-bottom: 8px;
    }
    .ability-bar-outer {
      height: 24px;
      background: var(--bg);
      border-radius: 6px;
      border: 1.5px solid var(--tan);
      overflow: hidden;
    }
    .ability-bar-inner {
      height: 100%;
      border-radius: 4px;
      display: flex;
      align-items: center;
      padding-left: 8px;
      min-width: 28px;
      transition: width 0.5s ease;
    }
    .ability-bar-inner span {
      font-family: 'Verdana', sans-serif;
      font-size: 11px;
      font-weight: 700;
      color: #fff;
    }
    
    .bar-pattern { background: linear-gradient(90deg, #E07850, #F4A080); }
    .bar-problem { background: linear-gradient(90deg, #D96A28, #F09560); }
    .bar-mental { background: linear-gradient(90deg, #5EB85E, #8CD98C); }
    .bar-memory { background: linear-gradient(90deg, #8A5BAF, #B48FD4); }
    .bar-verbal { background: linear-gradient(90deg, #5B8DEF, #8BB4F4); }
    .bar-logic { background: linear-gradient(90deg, #2A96B8, #65C4DA); }
    .bar-spatial { background: linear-gradient(90deg, #E85880, #F48CA8); }
    .bar-numerical { background: linear-gradient(90deg, #059669, #34D399); }

    .reset-btn {
      margin-top: 28px;
      background: none;
      border: none;
      font-family: 'Patrick Hand', cursive;
      font-size: 13px;
      color: var(--ink-light);
      cursor: pointer;
      opacity: 0.4;
      display: block;
      width: 100%;
      text-align: center;
    }

    /* Share Modal */
    .modal {
      position: fixed; inset: 0;
      background: rgba(0,0,0,0.6);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 200;
      padding: 16px;
    }
    .modal.show { display: flex; }
    .modal-box {
      background: var(--bg);
      border-radius: 20px;
      border: 3px solid var(--tan);
      padding: 20px;
      width: 100%;
      max-width: 340px;
      position: relative;
    }
    .modal-close {
      position: absolute;
      top: 12px; right: 12px;
      background: none; border: none;
      cursor: pointer; opacity: 0.5;
    }
    .modal-close svg { width: 18px; height: 18px; stroke: var(--ink); stroke-width: 2; }
    .modal-title {
      font-family: 'Patrick Hand', cursive;
      font-size: 18px;
      text-align: center;
      margin-bottom: 14px;
    }
    .share-preview {
      background: var(--card);
      border: 2px solid var(--tan);
      border-radius: 12px;
      overflow: hidden;
    }
    .share-preview canvas { width: 100%; display: block; }
    .share-btns { display: flex; gap: 10px; margin-top: 14px; }
    .share-btns button {
      flex: 1;
      background: var(--card);
      border: 2px solid var(--tan);
      border-radius: 12px;
      padding: 12px;
      font-family: 'Patrick Hand', cursive;
      font-size: 14px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
    }
    .share-btns button svg { width: 16px; height: 16px; stroke: currentColor; fill: none; stroke-width: 2; }
    .share-btns button.primary { background: var(--ink); color: #fff; border-color: var(--ink); }

    .toast {
      position: fixed;
      bottom: 90px;
      left: 50%;
      transform: translateX(-50%);
      background: var(--ink);
      color: #fff;
      padding: 10px 20px;
      border-radius: 20px;
      font-family: 'Patrick Hand', cursive;
      font-size: 14px;
      opacity: 0;
      transition: opacity 0.3s;
      z-index: 300;
    }
    .toast.show { opacity: 1; }
  </style>
</head>
<body>

<main>
  <div class="header">
    <button class="share-btn" onclick="openShare()">
      <svg viewBox="0 0 24 24"><path d="M4 12v8a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2v-8"/><polyline points="16 6 12 2 8 6"/><line x1="12" y1="2" x2="12" y2="15"/></svg>
      Share
    </button>
  </div>

  <div class="profile-card">
    <div class="avatar-side">
      <div class="avatar" onclick="document.getElementById('avatar-input').click()">
        <img id="avatar-img" src="" alt="">
        <svg id="avatar-icon" viewBox="0 0 64 64"><circle cx="32" cy="22" r="12"/><path d="M8 58 C8 44 18 36 32 36 C46 36 56 44 56 58"/></svg>
      </div>
      <input type="file" id="avatar-input" accept="image/*" onchange="uploadAvatar(this)">
      <div class="iq-display">
        <div class="iq-num" id="iq-num">--</div>
        <div class="iq-label">IQ</div>
        <div class="pct-badge" id="pct-badge" style="display:none;"></div>
      </div>
    </div>
    <div class="stats-side">
      <div class="stat-row">
        <span class="icon">üìù</span>
        <span class="val" id="answered">0</span>
        <span class="lbl">Answered</span>
      </div>
      <div class="stat-row">
        <span class="icon">üéØ</span>
        <span class="val" id="accuracy">0%</span>
        <span class="lbl">Accuracy</span>
      </div>
      <div class="stat-row">
        <span class="icon">üî•</span>
        <span class="val" id="best-streak">0</span>
        <span class="lbl">Best Streak</span>
      </div>
    </div>
  </div>

  <div class="level-section">
    <div class="level-header">
      <span class="lvl">‚≠ê Level <span id="level-num">1</span></span>
      <span class="xp" id="xp-text">0 / 150 XP</span>
    </div>
    <div class="level-bar-outer">
      <div class="level-bar-inner" id="level-bar" style="width:0%"></div>
    </div>
  </div>

  <div class="section-title">Abilities</div>
  <div class="abilities-grid" id="abilities"></div>

  <button class="reset-btn" onclick="resetData()">Reset Progress</button>
</main>

<nav>
  <a class="nav-btn" href="improve.html">
    <svg viewBox="0 0 24 24"><polyline points="23 6 13.5 15.5 8.5 10.5 1 18"/><polyline points="17 6 23 6 23 12"/></svg>
    Improve
  </a>
  <div class="nav-divider"></div>
  <a class="nav-btn active" href="profile.html">
    <svg viewBox="0 0 24 24"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>
    Profile
  </a>
</nav>

<div class="modal" id="share-modal">
  <div class="modal-box">
    <button class="modal-close" onclick="closeShare()">
      <svg viewBox="0 0 24 24" fill="none"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
    </button>
    <div class="modal-title">Share Your Stats</div>
    <div class="share-preview" id="share-preview"></div>
    <div class="share-btns">
      <button onclick="copyImg()"><svg viewBox="0 0 24 24"><rect x="9" y="9" width="13" height="13" rx="2"/><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"/></svg>Copy</button>
      <button class="primary" onclick="downloadImg()"><svg viewBox="0 0 24 24"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>Save</button>
    </div>
  </div>
</div>

<div class="toast" id="toast"></div>

<script src="data.js"></script>
<script>
const abilities = [
  { key: 'patternRecognition', name: 'Pattern Recognition', bar: 'pattern' },
  { key: 'problemSolving', name: 'Problem Solving', bar: 'problem' },
  { key: 'mentalAgility', name: 'Mental Agility', bar: 'mental' },
  { key: 'workingMemory', name: 'Working Memory', bar: 'memory' },
  { key: 'verbalReasoning', name: 'Verbal Reasoning', bar: 'verbal' },
  { key: 'logicalReasoning', name: 'Logical Reasoning', bar: 'logic' },
  { key: 'spatialAwareness', name: 'Spatial Awareness', bar: 'spatial' },
  { key: 'numericalReasoning', name: 'Numerical', bar: 'numerical' }
];

function load() {
  const d = IQData.load();
  
  // IQ
  if (d.iq) {
    document.getElementById('iq-num').textContent = d.iq;
    const pct = iqToPercentile(d.iq);
    document.getElementById('pct-badge').textContent = 'Top ' + formatPercentile(pct);
    document.getElementById('pct-badge').style.display = 'inline-block';
  }
  
  // Stats
  document.getElementById('answered').textContent = d.answered;
  document.getElementById('accuracy').textContent = IQData.getAccuracy() + '%';
  document.getElementById('best-streak').textContent = d.bestStreak;
  
  // Level
  document.getElementById('level-num').textContent = d.level;
  const xpInLevel = d.xp % 150;
  document.getElementById('xp-text').textContent = xpInLevel + ' / 150 XP';
  document.getElementById('level-bar').style.width = (xpInLevel / 150 * 100) + '%';
  
  // Avatar
  if (d.pic) {
    document.getElementById('avatar-img').src = d.pic;
    document.getElementById('avatar-img').style.display = 'block';
    document.getElementById('avatar-icon').style.display = 'none';
  }
  
  // Abilities
  const grid = document.getElementById('abilities');
  grid.innerHTML = '';
  abilities.forEach(a => {
    const pct = IQData.getStatPercent(a.key);
    const card = document.createElement('div');
    card.className = 'ability-card';
    card.innerHTML = `
      <div class="ability-name">${a.name}</div>
      <div class="ability-bar-outer">
        <div class="ability-bar-inner bar-${a.bar}" style="width:0%">
          <span>${pct}</span>
        </div>
      </div>
    `;
    grid.appendChild(card);
  });
  
  // Animate bars
  setTimeout(() => {
    document.querySelectorAll('.ability-bar-inner').forEach(bar => {
      const val = parseInt(bar.querySelector('span').textContent);
      bar.style.width = Math.max(20, val) + '%';
    });
  }, 100);
}

function uploadAvatar(input) {
  const file = input.files[0];
  if (!file) return;
  const reader = new FileReader();
  reader.onload = (e) => {
    const img = new Image();
    img.onload = () => {
      const canvas = document.createElement('canvas');
      canvas.width = canvas.height = 200;
      const ctx = canvas.getContext('2d');
      const min = Math.min(img.width, img.height);
      ctx.drawImage(img, (img.width-min)/2, (img.height-min)/2, min, min, 0, 0, 200, 200);
      const url = canvas.toDataURL('image/jpeg', 0.8);
      IQData.setProfilePic(url);
      document.getElementById('avatar-img').src = url;
      document.getElementById('avatar-img').style.display = 'block';
      document.getElementById('avatar-icon').style.display = 'none';
      toast('Photo updated!');
    };
    img.src = e.target.result;
  };
  reader.readAsDataURL(file);
}

let shareCanvas = null;

function openShare() {
  document.getElementById('share-modal').classList.add('show');
  genShareImg();
}

function closeShare() {
  document.getElementById('share-modal').classList.remove('show');
}

function genShareImg() {
  const d = IQData.load();
  const canvas = document.createElement('canvas');
  const W = 480, H = 640;
  canvas.width = W; canvas.height = H;
  const ctx = canvas.getContext('2d');
  
  // BG
  ctx.fillStyle = '#F2EBD9';
  ctx.fillRect(0, 0, W, H);
  
  // Card
  roundRect(ctx, 20, 20, W-40, H-40, 24, '#EDE5CF', '#C4AD8A', 3);
  
  const draw = () => {
    // IQ
    ctx.font = '700 80px Verdana';
    ctx.fillStyle = '#2A2018';
    ctx.textAlign = 'center';
    ctx.fillText(d.iq || '--', W/2, 180);
    
    ctx.font = '600 16px Patrick Hand';
    ctx.fillStyle = '#A89872';
    ctx.fillText('IQ', W/2, 205);
    
    // Percentile
    if (d.iq) {
      roundRect(ctx, W/2-55, 220, 110, 28, 14, '#A89872', null);
      ctx.font = '600 13px Patrick Hand';
      ctx.fillStyle = '#F2EBD9';
      ctx.fillText('Top ' + formatPercentile(iqToPercentile(d.iq)), W/2, 239);
    }
    
    // Stats
    const stats = [
      { v: d.answered, l: 'Answered' },
      { v: IQData.getAccuracy() + '%', l: 'Accuracy' },
      { v: d.bestStreak, l: 'Best üî•' }
    ];
    const sw = (W-80) / 3;
    stats.forEach((s, i) => {
      const x = 40 + sw*i + sw/2;
      ctx.font = '700 24px Verdana';
      ctx.fillStyle = '#2A2018';
      ctx.fillText(s.v, x, 300);
      ctx.font = '400 12px Patrick Hand';
      ctx.fillStyle = '#6B5740';
      ctx.fillText(s.l, x, 320);
    });
    
    // Abilities
    ctx.font = '600 12px Patrick Hand';
    ctx.fillStyle = '#A89872';
    ctx.textAlign = 'left';
    ctx.fillText('ABILITIES', 50, 365);
    
    const bars = [
      { n: 'Pattern', c: '#E07850', k: 'patternRecognition' },
      { n: 'Problem Solving', c: '#D96A28', k: 'problemSolving' },
      { n: 'Mental Agility', c: '#5EB85E', k: 'mentalAgility' },
      { n: 'Verbal', c: '#5B8DEF', k: 'verbalReasoning' },
      { n: 'Logical', c: '#2A96B8', k: 'logicalReasoning' }
    ];
    
    let y = 385;
    bars.forEach(b => {
      const v = IQData.getStatPercent(b.k);
      ctx.font = '600 10px Patrick Hand';
      ctx.fillStyle = '#6B5740';
      ctx.fillText(b.n, 50, y);
      
      roundRect(ctx, 50, y+5, W-100, 20, 4, '#D5C8AD', null);
      roundRect(ctx, 50, y+5, Math.max(30, (v/100)*(W-100)), 20, 4, b.c, null);
      
      ctx.font = '700 10px Verdana';
      ctx.fillStyle = '#fff';
      ctx.fillText(v, 58, y+19);
      y += 34;
    });
    
    // Footer
    ctx.font = '600 16px Patrick Hand';
    ctx.fillStyle = '#A89872';
    ctx.textAlign = 'center';
    ctx.fillText('üß† IQ Profile', W/2, H-45);
    
    shareCanvas = canvas;
    document.getElementById('share-preview').innerHTML = '';
    document.getElementById('share-preview').appendChild(canvas);
  };
  
  if (d.pic) {
    const img = new Image();
    img.onload = () => {
      ctx.save();
      ctx.beginPath();
      ctx.arc(W/2, 75, 40, 0, Math.PI*2);
      ctx.clip();
      ctx.drawImage(img, W/2-40, 35, 80, 80);
      ctx.restore();
      ctx.strokeStyle = '#C4AD8A';
      ctx.lineWidth = 3;
      ctx.beginPath();
      ctx.arc(W/2, 75, 40, 0, Math.PI*2);
      ctx.stroke();
      draw();
    };
    img.src = d.pic;
  } else {
    ctx.fillStyle = '#D5C8AD';
    ctx.beginPath();
    ctx.arc(W/2, 75, 40, 0, Math.PI*2);
    ctx.fill();
    ctx.strokeStyle = '#C4AD8A';
    ctx.lineWidth = 3;
    ctx.stroke();
    draw();
  }
}

function roundRect(ctx, x, y, w, h, r, fill, stroke, lw) {
  ctx.beginPath();
  ctx.moveTo(x+r, y);
  ctx.lineTo(x+w-r, y);
  ctx.quadraticCurveTo(x+w, y, x+w, y+r);
  ctx.lineTo(x+w, y+h-r);
  ctx.quadraticCurveTo(x+w, y+h, x+w-r, y+h);
  ctx.lineTo(x+r, y+h);
  ctx.quadraticCurveTo(x, y+h, x, y+h-r);
  ctx.lineTo(x, y+r);
  ctx.quadraticCurveTo(x, y, x+r, y);
  ctx.closePath();
  if (fill) { ctx.fillStyle = fill; ctx.fill(); }
  if (stroke) { ctx.strokeStyle = stroke; ctx.lineWidth = lw || 2; ctx.stroke(); }
}

async function copyImg() {
  if (!shareCanvas) return;
  try {
    const blob = await new Promise(r => shareCanvas.toBlob(r, 'image/png'));
    await navigator.clipboard.write([new ClipboardItem({ 'image/png': blob })]);
    toast('Copied!');
  } catch { toast('Copy failed'); }
}

function downloadImg() {
  if (!shareCanvas) return;
  const a = document.createElement('a');
  a.download = 'iq-profile.png';
  a.href = shareCanvas.toDataURL('image/png');
  a.click();
  toast('Saved!');
}

function resetData() {
  if (confirm('Reset all progress?')) {
    IQData.reset();
    location.reload();
  }
}

function toast(msg) {
  const t = document.getElementById('toast');
  t.textContent = msg;
  t.classList.add('show');
  setTimeout(() => t.classList.remove('show'), 2000);
}

document.getElementById('share-modal').onclick = e => {
  if (e.target.id === 'share-modal') closeShare();
};

load();
</script>
</body>
</html>